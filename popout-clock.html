<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecrã do Palestrante</title>
    <style>
     html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}

#normalModeContainer,
#debateModeContainer {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#debateModeContainer {
    padding: 1.5vh 1vw;
}

#debateModeContainer h2 {
    font-size: 2.5vw;
    margin-bottom: 1vh;
    text-align: center;
}

#debateParticipantsList {
    flex-grow: 1;
    display: grid;
    gap: 10px;
    width: 100%;
    overflow-y: auto;
}

/* Layouts por número de participantes */
#debateParticipantsList.layout-1 {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr;
}

#debateParticipantsList.layout-2 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: 1fr;
}

#debateParticipantsList.layout-3-4 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
}

#debateParticipantsList.layout-5-6 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(3, 1fr);
}

#debateParticipantsList.layout-7-8 {
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(4, 1fr);
}

#debateParticipantsList.layout-default {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    grid-auto-rows: 1fr;
}

.debate-participant-card {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    padding: 1vh;
    background-color: #222;
    border-radius: 10px;
}

.debate-participant-name {
    font-size: clamp(2vw, 4vh, 5vw);
    text-align: center;
    margin-bottom: 1vh;
    white-space: normal;
}

.debate-participant-time {
    font-size: clamp(4vw, 8vh, 10vw);
    text-align: center;
    min-width: 120px;
    padding: 1vh 2vw;
    border-radius: 8px;
}

/* Cores do tempo */
.green { background-color: #27ae60; color: white; }
.yellow { background-color: #f1c40f; color: black; }
.red { background-color: #e74c3c; color: white; }

/* Nome e relógio no modo normal */
#speakerName {
    font-size: clamp(4vw, 8vh, 10vw);
    margin-bottom: 1.5vh;
    text-align: center;
}

#clockDisplay {
    font-size: clamp(10vw, 25vh, 30vw);
    text-align: center;
    padding: 0.5vh 1vw;
    border-radius: 12px;
}

/* Mensagem do orador */
#speakerMessage {
    font-size: clamp(2vw, 4vh, 5vw);
    min-height: 7vh;
    margin-top: 1.5vh;
    text-align: center;
}

/* Hora atual no canto */
#currentTimePopout {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: clamp(1.5vw, 2.5vh, 3vw);
    color: #ccc;
}

/* Mobile — layout vertical */
@media (max-width: 768px) {
    #speakerName { font-size: 8vw; }
    #clockDisplay { font-size: 25vw; }
    #speakerMessage { font-size: 4vw; }
    .debate-participant-name { font-size: 6vw; }
    .debate-participant-time { font-size: 10vw; }
    #debateParticipantsList {
        grid-template-columns: 1fr !important;
        grid-auto-rows: 1fr;
    }
}

    </style>
</head>
<body>
    <div id="currentTimePopout">00:00:00</div>

    <div class="timer-display-container" id="normalModeContainer">
        <div id="speakerName">Nenhum Ativo</div>
        <div id="clockDisplay" class="green">00:00</div>
    </div>

    <div id="debateModeContainer">
        <h2>Tempo dos Participantes</h2>
        <div id="debateParticipantsList">
            </div>
    </div>

    <div id="speakerMessage"></div>

    <script>
        const speakerNameDisplay = document.getElementById('speakerName');
        const clockDisplay = document.getElementById('clockDisplay');
        const speakerMessageDisplay = document.getElementById('speakerMessage');
        const currentTimePopout = document.getElementById('currentTimePopout');

        const normalModeContainer = document.getElementById('normalModeContainer');
        const debateModeContainer = document.getElementById('debateModeContainer');
        const debateParticipantsList = document.getElementById('debateParticipantsList');

        let intervalId = null;

        function formatTime(seconds) {
            const isNegative = seconds < 0;
            const absSeconds = Math.abs(seconds);
            const minutes = Math.floor(absSeconds / 60);
            const remainingSeconds = absSeconds % 60;
            const sign = isNegative ? '-' : '';
            return `${sign}${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        // Esta função lida apenas com o modo normal
        function updateClockDisplay(name, timeLeft, colorClass) {
            speakerNameDisplay.textContent = name;
            clockDisplay.textContent = formatTime(timeLeft);
            
            clockDisplay.classList.remove('green', 'yellow', 'red');
            clockDisplay.classList.add(colorClass);

            normalModeContainer.style.display = 'flex';
            debateModeContainer.style.display = 'none';
            
            // Remove quaisquer classes de layout do debate
            debateParticipantsList.classList.remove('layout-1', 'layout-2', 'layout-3-4', 'layout-5-6', 'layout-7-8', 'layout-default');
        }

        // Função para atualizar a lista de oradores no Modo Debate
        function updateAllClocksDisplay(timersData) {
            debateParticipantsList.innerHTML = ''; // Limpa a lista existente

            // Primeiro, remove todas as classes de layout existentes
            debateParticipantsList.classList.remove('layout-1', 'layout-2', 'layout-3-4', 'layout-5-6', 'layout-7-8', 'layout-default');

            // Adiciona a classe de layout com base no número de participantes
            const numParticipants = timersData.length;
            if (numParticipants === 1) {
                debateParticipantsList.classList.add('layout-1');
            } else if (numParticipants === 2) {
                debateParticipantsList.classList.add('layout-2');
            } else if (numParticipants >= 3 && numParticipants <= 4) {
                debateParticipantsList.classList.add('layout-3-4');
            } else if (numParticipants >= 5 && numParticipants <= 6) {
                debateParticipantsList.classList.add('layout-5-6');
            } else if (numParticipants >= 7 && numParticipants <= 8) {
                debateParticipantsList.classList.add('layout-7-8');
            } else {
                debateParticipantsList.classList.add('layout-default'); // Para mais de 8
            }

            if (numParticipants === 0) {
                // Mensagem se não houver participantes no modo debate
                debateParticipantsList.innerHTML = '<p style="color: #bdc3c7; text-align: center; font-size: 2.5vw;">Nenhum participante ativo.</p>';
            } else {
                timersData.forEach(timer => {
                    const card = document.createElement('div');
                    card.className = 'debate-participant-card';
                    if (timer.isActive) {
                        card.classList.add('active-speaker'); // Destaca o orador ativo
                    }

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'debate-participant-name';
                    nameDiv.textContent = timer.name;

                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'debate-participant-time';
                    timeDiv.textContent = formatTime(timer.timeLeft);
                    timeDiv.classList.add(timer.color); // Aplica a cor (verde, amarelo, vermelho)

                    card.appendChild(nameDiv);
                    card.appendChild(timeDiv);
                    debateParticipantsList.appendChild(card);
                });
            }

            // Garante que o modo debate está visível
            normalModeContainer.style.display = 'none';
            debateModeContainer.style.display = 'flex';
        }

        function updateSpeakerMessage(message) {
            speakerMessageDisplay.textContent = message;
        }

        function updateCurrentTimePopout() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTimePopout.textContent = `${hours}:${minutes}:${seconds}`;
        }

        window.addEventListener('message', (event) => {
            const isLocalOrigin = ['null', window.location.origin].includes(event.origin);
            if (!isLocalOrigin && !event.origin.startsWith('file://')) {
                console.warn('Popout: Mensagem bloqueada de origem desconhecida:', event.origin);
                return;
            }

            if (event.data) {
                if (event.data.type === 'updateClock') {
                    // Modo normal: exibe um único orador
                    updateClockDisplay(event.data.name, event.data.timeLeft, event.data.color);
                } else if (event.data.type === 'updateAllClocks') {
                    // Modo Debate: exibe a lista de oradores
                    updateAllClocksDisplay(event.data.timers);
                } else if (event.data.type === 'updateMessage') {
                    updateSpeakerMessage(event.data.message);
                } else if (event.data.type === 'updateCurrentTime') {
                    currentTimePopout.textContent = event.data.time;
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            if (window.opener) {
                window.opener.postMessage({ type: 'popoutClosed' }, window.location.origin);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
             updateCurrentTimePopout(); // Atualiza uma vez ao carregar
             setInterval(updateCurrentTimePopout, 1000); // Atualiza a cada segundo
             if (window.opener) {
                window.opener.postMessage({ type: 'popoutReady' }, window.location.origin);
            }
        });
    </script>
</body>
</html>
